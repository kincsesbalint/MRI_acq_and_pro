These are not my own ideas but a collection of infos from the web. Sometimes I
did not put the reference there. Try to correct that later...
Balint Kincses
2021
Use of field map information in distortion correction with FSL


I. In case DWI images: another sequence with reversed phase encoding direction is acquired previous to the “main” dwi sequence. It is later fed into the FSL topup, which is good to estimate the susceptibility induced off resonance field. To also estimate subject movement, one feed into the result of topup to the eddy function, which uses this information to estimate and correct field inhomogeneity and eddy current caused distortion. (and not use applytopup which also aims to unwarp EPI images based on fieldmap information). It is the suggested application for dwi images. After eddy, one could use epi_reg function, without the use of any fieldmap, to register dwi to T1 (see for more information: https://www.fmrib.ox.ac.uk/primers/intro_primer/ExBox20/IntroBox20.html).
*****The distortion-corrected diffusion image can be aligned to the structural image using a 6 DOF (within-subject) registration with BBR. Since the distortion has already been corrected, no extra fieldmap information is needed and we can make a simpler call to the epi_reg script than in the previous example box that used gradient-echo fieldmaps.****
Author comment: after check the epi_reg script, it uses the flirt function with specified -fieldmap (and -echospacing, -pedirection) flag. Unfortunately, it is not clear what is it meant to be, but the recommendation of the link above is that one could use the fieldmap correction before the registration and it gets the same result as we use it in one step.


II. In case of fMRI (GE EPI), there are multiple ways to correct for the susceptibility induced field. Besides the used GE EPI sequence, one must acquire other sequences to estimate field inhomogeneity. The three options for acquisition are the following:
1. Acquire a fieldmap sequence or two gradient echo sequences with different echo times and compute the fieldmap. Unfortunately, this differs between vendors. Some vendor (e.g. Siemens) has default sequences for that and the output of that sequence is the phase images and a magnitude image. Later, FSL has prebuilt functions to calculate the fieldmap. In GE, the user has to set two gradient echo sequences with different echo time, and save the real and complex images separately and can compute the fieldmap.

2. Acquire two extra SE EPI sequence with (almost) the same parameters as GE EPI (almost because TE is definitely be different), but one has to be reversed phase encoding direction. It later could be used with the topup function (see section I. with dwi images).

3. Acquire one extra GE EPI the sequence with same parameters but opposing phase encoding direction. It also could use with the topup function to estimate fieldmap. 

After the acquisition, FSL has many function to proceed. Here we discuss three base functions which are recommended to process images related to field maps/inhomogeneities:
1. Fugue (https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FUGUE):
Based on its homepage, “it is, most generally, a set of tools for EPI distortion correction”. Also with the previously acquired fieldmap, which maps field inhomogeneity and the consequential image artifacts (distortion, signal loss), one could unwarp the EPI image and apply cost-function masking in registration(Is this really happening see. Section I Author comment). It is designed to improve registration. The epi_reg function uses fugue to modify the fieldmap, and this modified fieldmap is called in a flirt function under the -fieldmap flag.
2. Topup (https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/topup):
It is a function to estimate field inhomogeneities (aka fieldmap) from at least two reversed phase encoded (usually these are EPI sequences, not important if GE or SE) images. The results of the function are the spline representation of the field (default output), unwarped images (optional) and the field map itself (optional).
Hints for acqparam file generation: “The non-zero number in the second column means that is is along the y-direction, with a -1 meaning that k-space was traversed in the Anterior to Posterior direction and a +1 meaning that it was traversed in the Posterior to Anterior direction.”
“The fourth column is the total readout time (defined as the time from the centre of the first echo to the centre of the last) in seconds.” “Total readout time=echo spacing (dwell time) times the number of phase encoding steps.  If you use grappa, divide the number of phase encoding steps by the grappa factor.”
3. Applytopup (https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/topup/ApplyTopupUsersGuide):
This function is linked the previously mentioned topup function and has to be used in conjunction with that. It uses the the output of topup (spline representation of the field map, _fieldcoeff.nii.gz). It could be used to unwarp any EPI images. From FSL webpage: “In order to estimate and correct also for EC-induced distortions one will either need to run a tool like e.g. eddy_correct prior to running applytopup. Or one can feed the output from topup into the eddy tool”
“When using --method=jac it is in principle possible to generate one unwarped volume per input volue. However, all files specified together for --imain will be combined into a single output file. If one would want separate distortion corrected images (e.g. if one has scanned different sets of diffusion gradients for the two acquisitions) one can obtain that by applytopup --imain=my_blipup --datain=my_parameters --inindex=1 --topup=my_field --method=jac --out=my_good_blipup_images applytopup”
4. epi_reg: A tool for registering EPI images to high resolution structural images. It could receive field map data to improve registration (but how exactly???). Based on the practicals of FSL (https://www.fmrib.ox.ac.uk/primers/intro_primer/ExBox19/IntroBox19.html ; https://www.fmrib.ox.ac.uk/primers/intro_primer/ExBox20/IntroBox20.html), one could use it after applytopup and the result will be the same as we put the fieldmap as an input in the epi_reg function. “The distortion-corrected diffusion image can be aligned to the structural image using a 6 DOF (within-subject) registration with BBR. Since the distortion has already been corrected, no extra fieldmap information is needed and we can make a simpler call to the epi_reg script than in the previous example box (see links above, the author) that used gradient-echo fieldmaps.”
(https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=fsl;797493e.1405) “You can use the topup output (from --fout) after scaling it to rad/s (by multiplying the Hz by 2*pi) as the input fieldmap to epi_reg.  The only tricky thing might be getting a non-brain-extracted magnitude image.  The unwarped images from topup are good for the brain-extracted magnitude image, but you may need to either edit the epi_reg script to avoid the non-brain-extracted registration step, or to register a non-brain-extracted image to the space of the topup output to act as a surrogate.”

It may seem that fugue and applytopup have similar results but based on a forum discussion, they differ: 
https://www.jiscmail.ac.uk/cgi-bin/wa-jisc.exe?A2=ind1710&L=FSL&D=0&P=191450
Would there be any difference between applying fugue or applytopup in this stage?
yes, a quite big difference is that applytopup will take “Jacobian modulation” into account, and fugue will not. Jacobian modulation refers to the effect of stretching/compression of signal as a consequence of the distortions. For fMRI data it is not clear if there is any advantage in taking this into account, so it is not that one is necessarily better. But it means that your corrected data would look quite different post correction depending on which way you chose.
